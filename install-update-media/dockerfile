###Instructions###

# Build: docker build -t deakin-detonator-toolkit .
# Run: sudo docker run -it -p 5173:5173 deakin-detonator-toolkit /bin/bash
# Use: Open your browser and go to http://localhost:5173

# Use Kali Linux as the base image
FROM kalilinux/kali-rolling:latest

# Set working directory
WORKDIR /root

# Add Debian security updates and main repository to sources.list
RUN echo "deb http://security.debian.org/debian-security buster/updates main" >> /etc/apt/sources.list && \
    echo "deb http://ftp.au.debian.org/debian buster main" >> /etc/apt/sources.list

# Preconfigure debconf to restart services during upgrades without asking
RUN echo 'libc6 libraries/restart-without-asking boolean true' | debconf-set-selections

# Update package list
RUN apt-get update -y

# Install dependencies including Xvfb and other X11 utilities for debugging
RUN apt-get install -y \
    git \
    curl \
    pkgconf \
    libgtk-3-dev \
    libsoup2.4-dev \
    webkit2gtk-4.0 \
    nodejs \
    npm \
    xvfb \
    x11-xserver-utils

# Clone the Deakin Detonator Toolkit repository
RUN git clone https://github.com/Hardhat-Enterprises/Deakin-Detonator-Toolkit

# Change to the toolkit directory
WORKDIR /root/Deakin-Detonator-Toolkit

# Install Rust
RUN curl --proto '=https' --tlsv1.2 https://sh.rustup.rs -sSf | sh -s -- -y

# Load Cargo environment variables
ENV PATH="/root/.cargo/bin:${PATH}"

# Update package list again
RUN apt-get update -y

# Install Yarn globally
RUN npm install -g yarn

# Install Yarn dependencies
RUN yarn install

# Expose port 5173
EXPOSE 5173

# Start Tauri development environment
CMD ["yarn", "run", "tauri", "dev"]
